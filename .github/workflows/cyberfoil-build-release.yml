name: Build HappyFoil (release)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    container:
      image: devkitpro/devkita64:20251231

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Build + verify expected NRO name/location
        shell: bash
        run: |
          set -euo pipefail

          dkp-pacman -S --noconfirm --needed switch-ntfs-3g switch-lwext4
          make -j"$(nproc)"

          # Your Makefile outputs ./happyfoil.nro (TARGET := happyfoil)
          if [ ! -f "./happyfoil.nro" ]; then
            echo "ERROR: Expected ./happyfoil.nro not found"
            echo "Debug: any .nro files present?"
            find . -type f -name '*.nro' -print -exec ls -l {} \; || true
            exit 1
          fi

          # Ensure there aren't multiple .nro files
          COUNT="$(find . -type f -name '*.nro' | wc -l | tr -d ' ')"
          if [ "$COUNT" -ne 1 ]; then
            echo "ERROR: Expected exactly 1 .nro file, found $COUNT"
            find . -type f -name '*.nro' -print -exec ls -l {} \;
            exit 1
          fi

      - name: Package happyfoil.zip (switch/happyfoil/happyfoil.nro)
        shell: bash
        run: |
          set -euo pipefail

          rm -rf dist happyfoil.zip
          mkdir -p dist/switch/happyfoil
          cp -v ./happyfoil.nro dist/switch/happyfoil/happyfoil.nro

          # Create the zip using Python (no dependency on 'zip' being installed)
          python3 - <<'PY'
          import os, zipfile
          zip_name = "happyfoil.zip"
          base_dir = "dist"
          with zipfile.ZipFile(zip_name, "w", compression=zipfile.ZIP_DEFLATED) as z:
              for root, _, files in os.walk(os.path.join(base_dir, "switch")):
                  for f in files:
                      full_path = os.path.join(root, f)
                      arcname = full_path[len(base_dir)+1:]  # strip "dist/"
                      z.write(full_path, arcname)
          print("Created", zip_name)
          PY

          echo "---- package ----"
          ls -lah happyfoil.zip
          python3 - <<'PY'
          import zipfile
          with zipfile.ZipFile("happyfoil.zip") as z:
              print("\n".join(z.namelist()))
          PY

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: HappyFoil
          path: happyfoil.zip
          if-no-files-found: error

      - name: Publish GitHub Release (auto notes)
        uses: softprops/action-gh-release@v2
        with:
          files: happyfoil.zip
          generate_release_notes: true
