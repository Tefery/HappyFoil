name: Build CyberFoil (release)

on:
  push:
    tags:
      - "*.*.*"
      - "v*.*.*"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    container:
      image: devkitpro/devkita64:20251231

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Verify tag matches APP_VERSION in Makefile
        shell: bash
        run: |
          set -euo pipefail

          TAG="${GITHUB_REF_NAME}"
          TAG="${TAG#v}"   # allow tags like v1.3.9 as well

          if [ ! -f Makefile ]; then
            echo "ERROR: Makefile not found at repo root"
            exit 1
          fi

          # Extract APP_VERSION from Makefile line like: APP_VERSION := 1.3.9
          APP_VERSION="$(sed -nE 's/^[[:space:]]*APP_VERSION[[:space:]]*:?=[[:space:]]*//p' Makefile | head -n 1 | tr -d '\r' | tr -d '[:space:]')"

          if [ -z "$APP_VERSION" ]; then
            echo "ERROR: Could not read APP_VERSION from Makefile"
            exit 1
          fi

          echo "Tag version:      $TAG"
          echo "Makefile version: $APP_VERSION"

          if [ "$TAG" != "$APP_VERSION" ]; then
            echo "ERROR: Tag ($TAG) does not match APP_VERSION ($APP_VERSION)."
            echo "Fix: update APP_VERSION in Makefile or tag the correct version."
            exit 1
          fi

      - name: Build + verify expected NRO name/location
        shell: bash
        run: |
          set -euo pipefail

          dkp-pacman -S --noconfirm --needed switch-ntfs-3g switch-lwext4
          make -j"$(nproc)"

          # Your Makefile outputs ./cyberfoil.nro (TARGET := cyberfoil)
          if [ ! -f "./cyberfoil.nro" ]; then
            echo "ERROR: Expected ./cyberfoil.nro not found"
            echo "Debug: any .nro files present?"
            find . -type f -name '*.nro' -print -exec ls -l {} \; || true
            exit 1
          fi

          # Ensure there aren't multiple .nro files
          COUNT="$(find . -type f -name '*.nro' | wc -l | tr -d ' ')"
          if [ "$COUNT" -ne 1 ]; then
            echo "ERROR: Expected exactly 1 .nro file, found $COUNT"
            find . -type f -name '*.nro' -print -exec ls -l {} \;
            exit 1
          fi

      - name: Package cyberfoil.zip (switch/cyberfoil/cyberfoil.nro)
        shell: bash
        run: |
          set -euo pipefail

          rm -rf dist cyberfoil.zip
          mkdir -p dist/switch/cyberfoil
          cp -v ./cyberfoil.nro dist/switch/cyberfoil/cyberfoil.nro

          # Create the zip using Python (no dependency on 'zip' being installed)
          python3 - <<'PY'
          import os, zipfile
          zip_name = "cyberfoil.zip"
          base_dir = "dist"
          with zipfile.ZipFile(zip_name, "w", compression=zipfile.ZIP_DEFLATED) as z:
              for root, _, files in os.walk(os.path.join(base_dir, "switch")):
                  for f in files:
                      full_path = os.path.join(root, f)
                      arcname = full_path[len(base_dir)+1:]  # strip "dist/"
                      z.write(full_path, arcname)
          print("Created", zip_name)
          PY

          echo "---- package ----"
          ls -lah cyberfoil.zip
          python3 - <<'PY'
          import zipfile
          with zipfile.ZipFile("cyberfoil.zip") as z:
              print("\n".join(z.namelist()))
          PY

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: CyberFoil
          path: cyberfoil.zip
          if-no-files-found: error

      - name: Publish GitHub Release (auto notes)
        uses: softprops/action-gh-release@v2
        with:
          files: cyberfoil.zip
          generate_release_notes: true
